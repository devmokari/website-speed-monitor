<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Insights Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    h1 { margin-bottom: 12px; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fafafa; }
    select { padding: 6px 10px; font-size: 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Insights Dashboard</h1>
  <label>Select URL: <select id="urls"></select></label>

  <div class="charts">
    <div class="card">
      <h3>Mobile Score</h3>
      <canvas id="mobileChart" height="180"></canvas>
    </div>
    <div class="card">
      <h3>Desktop Score</h3>
      <canvas id="desktopChart" height="180"></canvas>
    </div>
  </div>

  <script>
    let mobileChart, desktopChart;

    function unionLabels(mobile, desktop) {
      const set = new Set();
      mobile.forEach(p => set.add(p.t));
      desktop.forEach(p => set.add(p.t));
      return Array.from(set).sort();
    }

    function toSeries(points, labels) {
      const map = Object.fromEntries(points.map(p => [p.t, p.y]));
      return labels.map(l => map[l] ?? null);
    }

    function formatLabel(tsUtc) {
      const d = new Date(tsUtc);
      // Melbourne is UTC+11 during daylight savings and UTC+10 otherwise; Intl handles it.
      return new Intl.DateTimeFormat('en-AU', {
        timeZone: 'Australia/Melbourne',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      }).format(d);
    }

    function renderCharts(data) {
      const labelsRaw = unionLabels(data.mobile, data.desktop);
      const labelsFormatted = labelsRaw.map(formatLabel);
      const mobileData = toSeries(data.mobile, labelsRaw);
      const desktopData = toSeries(data.desktop, labelsRaw);

      const commonOptions = {
        type: 'line',
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'Timestamp' }, ticks: { maxRotation: 45, minRotation: 45 } },
            y: { title: { display: true, text: 'Score (0-100)' }, suggestedMin: 0, suggestedMax: 100 }
          }
        }
      };

      if (mobileChart) mobileChart.destroy();
      mobileChart = new Chart(
        document.getElementById('mobileChart'),
        {
          ...commonOptions,
          data: {
            labels: labelsFormatted,
            datasets: [{ label: 'Mobile', data: mobileData, borderColor: '#0a66c2', backgroundColor: 'rgba(10,102,194,0.2)' }]
          }
        }
      );

      if (desktopChart) desktopChart.destroy();
      desktopChart = new Chart(
        document.getElementById('desktopChart'),
        {
          ...commonOptions,
          data: {
            labels: labelsFormatted,
            datasets: [{ label: 'Desktop', data: desktopData, borderColor: '#22a06b', backgroundColor: 'rgba(34,160,107,0.2)' }]
          }
        }
      );
    }

    async function loadUrls() {
      const res = await fetch("/urls");
      const data = await res.json();
      const dropdown = document.getElementById("urls");
      dropdown.innerHTML = "";

      data.urls.forEach(url => {
        const opt = document.createElement("option");
        opt.value = url;
        opt.textContent = url;
        dropdown.appendChild(opt);
      });

      if (data.urls.length > 0) {
        dropdown.value = data.urls[0];
        fetchData(data.urls[0]);
      }
    }

    async function fetchData(url) {
      const res = await fetch("/data?url=" + encodeURIComponent(url));
      const json = await res.json();
      renderCharts(json);
    }

    document.getElementById("urls").addEventListener("change", e => {
      fetchData(e.target.value);
    });

    loadUrls();
  </script>
</body>
</html>
